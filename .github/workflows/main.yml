name: Fly Deploy
on: [push]
env: 
  FLY_API_TOKEN:  ${{ secrets.FLY_API_TOKEN }}
jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    outputs:
      app_host: ${{ steps.deploy.outputs.app_host }}
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --remote-only
      - id: deploy
        # run: echo "::set-output name=app_host::$(flyctl status -j |jq .Hostname|tr -d '"')"
        run: echo '::set-output name=app_host::cool-water-1296.fly.dev'
      - run: echo "APP_HOST=$(flyctl status -j |jq .Hostname|tr -d '"')" |tee -a $GITHUB_ENV 
  
  e2e_test:
    name: End to end tests
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - run: echo ${{ needs.deploy.outputs.app_host }}
      - name: Run k6 local test
        uses: grafana/k6-action@v0.2.0
        with:
          filename: script.js
          flags: --vus 50 --duration 10s -e APP_HOST=http://${{ needs.deploy.outputs.app_host }}
